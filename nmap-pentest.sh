#!/usr/bin/env bash

# Install necessary tools
sudo apt-get update
sudo apt-get install -y nmap sqlite3

# Download and install nmap-formatter
VERSION=v2.1.0
curl -L "https://github.com/vdjagilev/nmap-formatter/releases/download/$VERSION/nmap-formatter-linux-amd64.tar.gz" -o nmap-formatter.tar.gz
tar -xzvf nmap-formatter.tar.gz
sudo mv nmap-formatter /usr/local/bin

# Create results directory
mkdir -p /home/nmap/result
cd /home/nmap

# Function to perform NMAP scan and save results to SQLite database
perform_nmap_scan() {
    local hostname=$1
    local ip=$2
    local provider=$3

    echo "Performing NMAP scan for $hostname ($ip) under $provider"
    local output_file="$hostname.xml"
    nmap -p- -T4 --max-rtt-timeout 300ms "$ip" -oX "$output_file"

    echo "Saving NMAP results to SQLite database"
    nmap-formatter sqlite "$output_file" --sqlite-dsn nmap.db

    # Ensure the database and table exist
    sqlite3 nmap.db "CREATE TABLE IF NOT EXISTS boundary (host TEXT, provider TEXT , ip TEXT);"
    sqlite3 nmap.db "INSERT INTO boundary (host, provider) VALUES ('$hostname', '$provider', '$ip');"
}

# Read the ENDPOINTS environment variable, splitting on newlines
IFS=$'\n' read -rd '' -a ADDR <<< "$ENDPOINTS"
for entry in "${ADDR[@]}"; do
    # Split each line into parts based on the delimiter '|'
    IFS='|' read -ra PARTS <<< "$entry"
    if [ "${#PARTS[@]}" -eq 3 ]; then
        perform_nmap_scan "${PARTS[0]}" "${PARTS[1]}" "${PARTS[2]}"
    else
        echo "Skipping malformed entry: $entry"
    fi
done

# Copy the database to the result directory
sudo cp nmap.db /home/nmap/result/nmap.db
echo "All NMAP scans completed and result saved to SQLite database file at /home/nmap/result/nmap.db"
